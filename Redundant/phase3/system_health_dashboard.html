<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signature Auth - System Health Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f0f2f5;
            color: #1a1a1a;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: #fff;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .metric-card {
            background-color: #fff;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .metric-title {
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .metric-subtitle {
            font-size: 14px;
            color: #666;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-healthy {
            background-color: #d4edda;
            color: #155724;
        }

        .status-warning {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
        }

        .status-critical {
            background-color: #721c24;
            color: #fff;
        }

        .chart-container {
            background-color: #fff;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 24px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 16px;
        }

        .alerts-container {
            background-color: #fff;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .alert-item {
            padding: 16px;
            border-left: 4px solid;
            margin-bottom: 12px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        .alert-info {
            border-left-color: #2196F3;
        }

        .alert-warning {
            border-left-color: #FF9800;
        }

        .alert-error {
            border-left-color: #F44336;
        }

        .alert-critical {
            border-left-color: #D32F2F;
        }

        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .alert-component {
            font-weight: 500;
        }

        .alert-time {
            font-size: 12px;
            color: #666;
        }

        .alert-message {
            font-size: 14px;
            color: #333;
        }

        .refresh-btn {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .refresh-btn:hover {
            background-color: #1976D2;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        canvas {
            max-height: 300px;
        }

        .metric-trend {
            display: inline-flex;
            align-items: center;
            margin-left: 8px;
            font-size: 14px;
        }

        .trend-up {
            color: #4CAF50;
        }

        .trend-down {
            color: #F44336;
        }

        .trend-stable {
            color: #666;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>System Health Dashboard</h1>
                    <p class="subtitle">Real-time monitoring for Signature Authentication System</p>
                </div>
                <div>
                    <button class="refresh-btn" onclick="refreshDashboard()">â†» Refresh</button>
                </div>
            </div>
        </header>

        <div id="error-container"></div>

        <div class="dashboard-grid" id="metrics-grid">
            <div class="loading">Loading metrics...</div>
        </div>

        <div class="chart-container">
            <h2 class="chart-title">Authentication Success Rate (Last 7 Days)</h2>
            <canvas id="authChart"></canvas>
        </div>

        <div class="chart-container">
            <h2 class="chart-title">ML Processing Performance (Last 7 Days)</h2>
            <canvas id="mlChart"></canvas>
        </div>

        <div class="alerts-container">
            <h2 class="chart-title">Recent Alerts</h2>
            <div id="alerts-list">
                <div class="loading">Loading alerts...</div>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE_URL = window.location.origin + '/api';
        const REFRESH_INTERVAL = 60000; // 1 minute

        // State
        let authChart = null;
        let mlChart = null;
        let autoRefreshInterval = null;

        // Initialize dashboard
        async function initDashboard() {
            await refreshDashboard();
            
            // Set up auto-refresh
            autoRefreshInterval = setInterval(refreshDashboard, REFRESH_INTERVAL);
        }

        // Refresh all dashboard data
        async function refreshDashboard() {
            console.log('Refreshing dashboard...');
            
            try {
                // Clear any previous errors
                document.getElementById('error-container').innerHTML = '';
                
                // Fetch all data in parallel
                const [systemStatus, authData, mlData, alerts] = await Promise.all([
                    fetchSystemStatus(),
                    fetchAuthData(),
                    fetchMLData(),
                    fetchAlerts()
                ]);
                
                // Update UI
                updateMetrics(systemStatus);
                updateAuthChart(authData);
                updateMLChart(mlData);
                updateAlerts(alerts);
                
            } catch (error) {
                showError('Failed to refresh dashboard: ' + error.message);
            }
        }

        // Fetch system status
        async function fetchSystemStatus() {
            // In a real implementation, this would fetch from the API
            // For now, we'll simulate the data
            return {
                dataConsistency: {
                    status: 'Healthy',
                    healthScore: 99.5,
                    details: {
                        nullFormats: 0,
                        nullData: 0
                    }
                },
                authentication: {
                    status: 'Warning',
                    avgSuccessRate: 92.3,
                    attemptsToday: 145
                },
                mlProcessing: {
                    status: 'Healthy',
                    avgMedianTime: 425,
                    performanceAlerts: 0
                },
                storage: {
                    status: 'Healthy',
                    totalStorageMB: 234.5,
                    signaturesMB: 156.3,
                    shapesMB: 78.2
                },
                overview: {
                    totalUsers: 127,
                    totalSignatures: 892,
                    totalShapes: 1153,
                    unacknowledgedAlerts: 3
                }
            };
        }

        // Fetch authentication data
        async function fetchAuthData() {
            // Simulated data
            const last7Days = [];
            const today = new Date();
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                
                last7Days.push({
                    date: date.toISOString().split('T')[0],
                    successRate: 90 + Math.random() * 10,
                    totalAttempts: Math.floor(100 + Math.random() * 200)
                });
            }
            
            return last7Days;
        }

        // Fetch ML processing data
        async function fetchMLData() {
            // Simulated data
            const last7Days = [];
            const today = new Date();
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                
                last7Days.push({
                    date: date.toISOString().split('T')[0],
                    avgTime: 300 + Math.random() * 400,
                    p95Time: 500 + Math.random() * 800,
                    maxTime: 800 + Math.random() * 1200
                });
            }
            
            return last7Days;
        }

        // Fetch alerts
        async function fetchAlerts() {
            // Simulated data
            return [
                {
                    id: 1,
                    severity: 'warning',
                    component: 'Authentication System',
                    message: 'High authentication failure rate: 23.5% in the last hour',
                    createdAt: new Date(Date.now() - 30 * 60000).toISOString()
                },
                {
                    id: 2,
                    severity: 'info',
                    component: 'ML Processing',
                    message: 'Processing performance improved by 15% this week',
                    createdAt: new Date(Date.now() - 120 * 60000).toISOString()
                },
                {
                    id: 3,
                    severity: 'error',
                    component: 'Data Consistency',
                    message: '2 shapes records missing metrics data',
                    createdAt: new Date(Date.now() - 180 * 60000).toISOString()
                }
            ];
        }

        // Update metrics display
        function updateMetrics(data) {
            const metricsGrid = document.getElementById('metrics-grid');
            
            metricsGrid.innerHTML = `
                <div class="metric-card">
                    <div class="metric-header">
                        <h3 class="metric-title">Data Health Score</h3>
                        <span class="status-badge status-${data.dataConsistency.status.toLowerCase()}">${data.dataConsistency.status}</span>
                    </div>
                    <div class="metric-value">${data.dataConsistency.healthScore}%</div>
                    <div class="metric-subtitle">Data consistency across all tables</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-header">
                        <h3 class="metric-title">Auth Success Rate</h3>
                        <span class="status-badge status-${data.authentication.status.toLowerCase()}">${data.authentication.status}</span>
                    </div>
                    <div class="metric-value">
                        ${data.authentication.avgSuccessRate}%
                        <span class="metric-trend trend-down">â†“ 2.1%</span>
                    </div>
                    <div class="metric-subtitle">${data.authentication.attemptsToday} attempts today</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-header">
                        <h3 class="metric-title">ML Processing</h3>
                        <span class="status-badge status-${data.mlProcessing.status.toLowerCase()}">${data.mlProcessing.status}</span>
                    </div>
                    <div class="metric-value">${data.mlProcessing.avgMedianTime}ms</div>
                    <div class="metric-subtitle">Average processing time</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-header">
                        <h3 class="metric-title">Storage Usage</h3>
                        <span class="status-badge status-${data.storage.status.toLowerCase()}">${data.storage.status}</span>
                    </div>
                    <div class="metric-value">${data.storage.totalStorageMB} MB</div>
                    <div class="metric-subtitle">Signatures: ${data.storage.signaturesMB} MB, Shapes: ${data.storage.shapesMB} MB</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-header">
                        <h3 class="metric-title">Total Users</h3>
                    </div>
                    <div class="metric-value">${data.overview.totalUsers}</div>
                    <div class="metric-subtitle">${data.overview.totalSignatures} signatures, ${data.overview.totalShapes} shapes</div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-header">
                        <h3 class="metric-title">Active Alerts</h3>
                    </div>
                    <div class="metric-value">${data.overview.unacknowledgedAlerts}</div>
                    <div class="metric-subtitle">Unacknowledged alerts</div>
                </div>
            `;
        }

        // Update authentication chart
        function updateAuthChart(data) {
            const ctx = document.getElementById('authChart').getContext('2d');
            
            if (authChart) {
                authChart.destroy();
            }
            
            authChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => formatDate(d.date)),
                    datasets: [{
                        label: 'Success Rate (%)',
                        data: data.map(d => d.successRate),
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Total Attempts',
                        data: data.map(d => d.totalAttempts),
                        borderColor: '#2196F3',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        tension: 0.4,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Success Rate (%)'
                            },
                            min: 0,
                            max: 100
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Total Attempts'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        // Update ML processing chart
        function updateMLChart(data) {
            const ctx = document.getElementById('mlChart').getContext('2d');
            
            if (mlChart) {
                mlChart.destroy();
            }
            
            mlChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(d => formatDate(d.date)),
                    datasets: [{
                        label: 'Average Time (ms)',
                        data: data.map(d => d.avgTime),
                        borderColor: '#FF9800',
                        backgroundColor: 'rgba(255, 152, 0, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'P95 Time (ms)',
                        data: data.map(d => d.p95Time),
                        borderColor: '#F44336',
                        backgroundColor: 'rgba(244, 67, 54, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Max Time (ms)',
                        data: data.map(d => d.maxTime),
                        borderColor: '#9C27B0',
                        backgroundColor: 'rgba(156, 39, 176, 0.1)',
                        tension: 0.4,
                        borderDash: [5, 5]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Processing Time (ms)'
                            },
                            min: 0
                        }
                    }
                }
            });
        }

        // Update alerts list
        function updateAlerts(alerts) {
            const alertsList = document.getElementById('alerts-list');
            
            if (alerts.length === 0) {
                alertsList.innerHTML = '<p style="color: #666; text-align: center;">No recent alerts</p>';
                return;
            }
            
            alertsList.innerHTML = alerts.map(alert => `
                <div class="alert-item alert-${alert.severity}">
                    <div class="alert-header">
                        <span class="alert-component">${alert.component}</span>
                        <span class="alert-time">${formatTime(alert.createdAt)}</span>
                    </div>
                    <div class="alert-message">${alert.message}</div>
                </div>
            `).join('');
        }

        // Show error message
        function showError(message) {
            document.getElementById('error-container').innerHTML = `
                <div class="error-message">
                    <strong>Error:</strong> ${message}
                </div>
            `;
        }

        // Format date for display
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // Format time for display
        function formatTime(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) {
                return 'Just now';
            } else if (diff < 3600000) {
                return Math.floor(diff / 60000) + ' minutes ago';
            } else if (diff < 86400000) {
                return Math.floor(diff / 3600000) + ' hours ago';
            } else {
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: 'numeric' });
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initDashboard);
        
        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
        });
    </script>
</body>
</html>