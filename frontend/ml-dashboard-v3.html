<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ML Dashboard - Redesigned</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .header {
            background: white;
            padding: 20px;
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-selector select {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        .tabs {
            background: white;
            border-bottom: 1px solid #ddd;
        }

        .tab-buttons {
            display: flex;
            padding: 0 20px;
        }

        .tab-button {
            padding: 15px 25px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
        }

        .tab-button.active {
            border-bottom-color: #007AFF;
            color: #007AFF;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Data Tab Styles */
        .baseline-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #e3f2fd;
        }

        .baseline-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #1976d2;
        }

        .baseline-grid {
            display: grid;
            gap: 16px;
            margin-top: 16px;
        }

        /* Row 1: 5 columns for main baseline data */
        .baseline-grid-row1 {
            grid-template-columns: repeat(5, 1fr);
        }

        /* Row 2: 4 columns for enhanced features (more space per column) */
        .baseline-grid-row2 {
            grid-template-columns: repeat(4, 1fr);
            margin-top: 16px; /* Space between rows */
        }

        /* Responsive adjustments */
        @media (max-width: 1400px) {
            .baseline-grid-row1 {
                grid-template-columns: repeat(3, 1fr);
            }
            .baseline-grid-row2 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .baseline-grid-row1,
            .baseline-grid-row2 {
                grid-template-columns: 1fr;
            }
        }

        .baseline-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
        }

        .group-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #555;
        }

        .metric-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 13px;
        }

        .auth-attempts {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .attempt-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .attempt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .attempt-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .attempt-title {
            font-size: 16px;
            font-weight: 600;
        }

        .attempt-meta {
            font-size: 13px;
            color: #666;
        }

        .attempt-result {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
        }

        .status-failed {
            color: #d32f2f;
        }

        .status-passed {
            color: #388e3c;
        }

        .attempt-data {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .data-group {
            background: #fafafa;
            padding: 15px;
            border-radius: 6px;
        }

        .data-group-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: #333;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }

        .data-metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            font-size: 13px;
        }

        .metric-name {
            color: #555;
        }

        .metric-value {
            font-weight: 500;
            font-family: 'Courier New', monospace;
        }

        /* Images Tab Styles */
        .images-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            height: calc(100vh - 200px);
        }

        .baseline-images {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e3f2fd;
        }

        .baseline-images-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #1976d2;
        }

        .auth-images {
            background: white;
            padding: 20px;
            border-radius: 8px;
            overflow-y: auto;
        }

        .auth-images-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            position: sticky;
            top: 0;
            background: white;
            z-index: 1;
        }

        .image-group {
            margin-bottom: 25px;
        }

        .image-group-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #555;
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .image-item {
            text-align: center;
        }

        .image-canvas {
            width: 150px;
            height: 100px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            margin-bottom: 5px;
        }

        .image-label {
            font-size: 12px;
            color: #666;
        }

        .attempt-image-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .attempt-image-header {
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
        }

        /* Raw Tab Styles */
        .raw-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .raw-section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
        }

        .raw-json {
            background: #f5f5f5;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }

        .raw-json pre {
            margin: 0;
            font-family: 'Courier New', Courier, monospace;
            font-size: 12px;
            line-height: 1.5;
            color: #333;
                }


    </style>
</head>
<body>
    <div class="header">
        <h1>ML Dashboard</h1>
        <div class="user-selector">
            <label for="userSelect">User:</label>
            <select id="userSelect">
                <option value="">Loading users...</option>
            </select>
        </div>
    </div>

    <div class="tabs">
        <div class="tab-buttons">
            <button class="tab-button active" onclick="switchTab('data')">Data</button>
            <button class="tab-button" onclick="switchTab('images')">Images</button>
            <button class="tab-button" onclick="switchTab('raw')">Raw</button>
        </div>
    </div>

    <div class="main-content">
        <!-- Data Tab -->
        <div id="dataTab" class="tab-content active">
            <div class="loading">Loading data...</div>
        </div>

        <!-- Images Tab -->
        <div id="imagesTab" class="tab-content">
            <div class="loading">Loading images...</div>
        </div>

        <!-- Raw Tab -->
        <div id="rawTab" class="tab-content">
            <div class="loading">Loading raw data...</div>
        </div>
    </div>

    <script>
        const API_URL = 'https://chickenscratch.onrender.com';
        let currentData = null;
        let currentUser = null;


        // Safe value retrieval with enhanced feature support
        function safeGetValue(obj, property, defaultValue = 'N/A') {
            // Get metrics object which contains all features
            const metrics = obj.metrics || obj || {};
            
            // Check if this feature is excluded
            if (metrics._excluded_features && metrics._excluded_features.includes(property)) {
                return 'Not supported';
            }
            
            // Check for the property in metrics
            if (metrics[property] !== undefined) {
                const value = metrics[property];
                if (typeof value === 'number') {
                    return isNaN(value) ? 'N/A' : value.toFixed(2);
                }
                return value;
            }
            
            return defaultValue;
        }

        // Format feature names for display
        function formatFeatureName(featureName) {
            return featureName
                .replace(/_/g, ' ')
                .replace(/\b\w/g, l => l.toUpperCase());
        }


        // Initialize the dashboard
        async function init() {
            await loadUsers();
            const userSelect = document.getElementById('userSelect');
            if (userSelect.options.length > 0) {
                userSelect.selectedIndex = 0;
                await loadUserData(userSelect.value);
            }
        }

        // Load available users
        async function loadUsers() {
            try {
                const response = await fetch(`${API_URL}/users`);
                const users = await response.json();
                
                const userSelect = document.getElementById('userSelect');
                userSelect.innerHTML = '';
                
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.username;
                    option.textContent = user.username;
                    userSelect.appendChild(option);
                });
                
                userSelect.addEventListener('change', (e) => {
                    loadUserData(e.target.value);
                });
            } catch (error) {
                console.error('Error loading users:', error);
                // Fallback to default users
                const userSelect = document.getElementById('userSelect');
                userSelect.innerHTML = `
                    <option value="testuser">testuser</option>
                    <option value="demo">demo</option>
                    <option value="admin">admin</option>
                `;
                userSelect.addEventListener('change', (e) => {
                    loadUserData(e.target.value);
                });
            }
        }

        // Load user data from API
        async function loadUserData(username) {
            if (!username) return;
            
            currentUser = username;
            
            // Show loading state
            document.getElementById('dataTab').innerHTML = '<div class="loading">Loading data...</div>';
            document.getElementById('imagesTab').innerHTML = '<div class="loading">Loading images...</div>';
            document.getElementById('rawTab').innerHTML = '<div class="loading">Loading raw data...</div>';
            
            try {
                const response = await fetch(`${API_URL}/api/user/${username}/detailed-analysis`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                currentData = await response.json();
                
                // Render all tabs
                renderDataTab();
                renderImagesTab();
                renderRawTab();
            } catch (error) {
                console.error('Error loading user data:', error);
                document.getElementById('dataTab').innerHTML = `
                    <div class="error">
                        Error loading data for user "${username}": ${error.message}
                    </div>
                `;
                document.getElementById('imagesTab').innerHTML = `
                    <div class="error">
                        Error loading data for user "${username}": ${error.message}
                    </div>
                `;
                document.getElementById('rawTab').innerHTML = `
                    <div class="error">
                        Error loading data for user "${username}": ${error.message}
                    </div>
                `;
            }
        }

        // Format metric value with baseline comparison
        function formatMetricValue(value, baseline, showPercentage = true) {
            if (value === null || value === undefined || baseline === null || baseline === undefined) {
                return 'N/A';
            }
            
            const percentage = Math.round((value / baseline) * 100);
            if (showPercentage) {
                return `${value}/${baseline} (${percentage}%)`;
            }
            return `${value}`;
        }

        // Format percentage value
        function formatPercentage(value) {
            if (value === null || value === undefined) return 'N/A';
            return `${Math.round(value)}%`;
        }

        // Format timestamp
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleString('en-US', {
                month: 'numeric',
                day: 'numeric',
                year: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });
        }

        // Render comprehensive enhanced biometric features
        function renderComprehensiveEnhancedFeatures(attempt, baseline) {
            if (!attempt._enhanced_features_enabled) {
                return '';
            }
            
            let html = '';
            
            // Pressure Analysis (conditional on device support)
            if (!attempt._excluded_features?.includes('avg_pressure')) {
                html += `
                    <div class="data-group">
                        <div class="data-group-title">Pressure Analysis</div>
                        <div class="data-metric">
                            <span class="metric-name">Avg Pressure:</span>
                            <span class="metric-value">${formatMetricValue(attempt.avg_pressure?.toFixed(3), baseline.avg_pressure?.toFixed(3))}</span>
                        </div>
                        <div class="data-metric">
                            <span class="metric-name">Max Pressure:</span>
                            <span class="metric-value">${formatMetricValue(attempt.max_pressure?.toFixed(3), baseline.max_pressure?.toFixed(3))}</span>
                        </div>
                        <div class="data-metric">
                            <span class="metric-name">Min Pressure:</span>
                            <span class="metric-value">${formatMetricValue(attempt.min_pressure?.toFixed(3), baseline.min_pressure?.toFixed(3))}</span>
                        </div>
                        <div class="data-metric">
                            <span class="metric-name">Pressure Std:</span>
                            <span class="metric-value">${formatMetricValue(attempt.pressure_std?.toFixed(3), baseline.pressure_std?.toFixed(3))}</span>
                        </div>
                        <div class="data-metric">
                            <span class="metric-name">Pressure Range:</span>
                            <span class="metric-value">${formatMetricValue(attempt.pressure_range?.toFixed(3), baseline.pressure_range?.toFixed(3))}</span>
                        </div>
                        <div class="data-metric">
                            <span class="metric-name">Contact Time Ratio:</span>
                            <span class="metric-value">${formatMetricValue(attempt.contact_time_ratio?.toFixed(3), baseline.contact_time_ratio?.toFixed(3))}</span>
                        </div>
                        <div class="data-metric">
                            <span class="metric-name">Pressure Buildup Rate:</span>
                            <span class="metric-value">${formatMetricValue(attempt.pressure_buildup_rate?.toFixed(3), baseline.pressure_buildup_rate?.toFixed(3))}</span>
                        </div>
                        <div class="data-metric">
                            <span class="metric-name">Pressure Release Rate:</span>
                            <span class="metric-value">${formatMetricValue(attempt.pressure_release_rate?.toFixed(3), baseline.pressure_release_rate?.toFixed(3))}</span>
                        </div>
                    </div>`;
            } else {
                html += `
                    <div class="data-group">
                        <div class="data-group-title">Pressure Analysis</div>
                        <div class="data-metric">
                            <span class="metric-name">Pressure Features:</span>
                            <span class="metric-value text-muted">Not supported on this device</span>
                        </div>
                    </div>`;
            }
            
            // Behavioral Timing
            html += `
                <div class="data-group">
                    <div class="data-group-title">Behavioral Timing</div>
                    <div class="data-metric">
                        <span class="metric-name">Pause Detection:</span>
                        <span class="metric-value">${formatMetricValue(attempt.pause_count?.toFixed(1), baseline.pause_count?.toFixed(1))}</span>
                    </div>
                    <div class="data-metric">
                        <span class="metric-name">Rhythm Consistency:</span>
                        <span class="metric-value">${formatMetricValue(attempt.rhythm_consistency?.toFixed(3), baseline.rhythm_consistency?.toFixed(3))}</span>
                    </div>
                    <div class="data-metric">
                        <span class="metric-name">Tempo Variation:</span>
                        <span class="metric-value">${formatMetricValue(attempt.tempo_variation?.toFixed(3), baseline.tempo_variation?.toFixed(3))}</span>
                    </div>
                    <div class="data-metric">
                        <span class="metric-name">Dwell Time Patterns:</span>
                        <span class="metric-value">${formatMetricValue(attempt.dwell_time_patterns?.toFixed(3), baseline.dwell_time_patterns?.toFixed(3))}</span>
                    </div>
                    <div class="data-metric">
                        <span class="metric-name">Inter Stroke Timing:</span>
                        <span class="metric-value">${formatMetricValue(attempt.inter_stroke_timing?.toFixed(1), baseline.inter_stroke_timing?.toFixed(1))} ms</span>
                    </div>
                    <div class="data-metric">
                        <span class="metric-name">Drawing Duration Total:</span>
                        <span class="metric-value">${formatMetricValue(attempt.total_duration_ms?.toFixed(0), baseline.total_duration_ms?.toFixed(0))} ms</span>
                    </div>
                    <div class="data-metric">
                        <span class="metric-name">Pause Time Ratio:</span>
                        <span class="metric-value">${formatMetricValue(attempt.pause_time_ratio?.toFixed(3), baseline.pause_time_ratio?.toFixed(3))}</span>
                    </div>
                    <div class="data-metric">
                        <span class="metric-name">Avg Stroke Duration:</span>
                        <span class="metric-value">${formatMetricValue(attempt.avg_stroke_duration?.toFixed(1), baseline.avg_stroke_duration?.toFixed(1))} ms</span>
                    </div>
                </div>`;
            
            // Advanced Geometric
            html += `
                <div class="data-group">
                    <div class="data-group-title">Advanced Geometric</div>
                    <div class="data-metric">
                        <span class="metric-name">Stroke Complexity:</span>
                        <span class="metric-value">${formatMetricValue(attempt.stroke_complexity?.toFixed(3), baseline.stroke_complexity?.toFixed(3))}</span>
                    </div>
                    <div class="data-metric">
                        <span class="metric-name">Tremor Index:</span>
                        <span class="metric-value">${formatMetricValue(attempt.tremor_index?.toFixed(3), baseline.tremor_index?.toFixed(3))}</span>
                    </div>
                    <div class="data-metric">
                        <span class="metric-name">Smoothness Index:</span>
                        <span class="metric-value">${formatMetricValue(attempt.smoothness_index?.toFixed(3), baseline.smoothness_index?.toFixed(3))}</span>
                    </div>
                    <div class="data-metric">
                        <span class="metric-name">Direction Changes:</span>
                        <span class="metric-value">${formatMetricValue(attempt.direction_changes?.toFixed(1), baseline.direction_changes?.toFixed(1))}</span>
                    </div>
                    <div class="data-metric">
                        <span class="metric-name">Curvature Analysis:</span>
                        <span class="metric-value">${formatMetricValue(attempt.curvature_analysis?.toFixed(3), baseline.curvature_analysis?.toFixed(3))}</span>
                    </div>
                    <div class="data-metric">
                        <span class="metric-name">Spatial Efficiency:</span>
                        <span class="metric-value">${formatMetricValue(attempt.spatial_efficiency?.toFixed(3), baseline.spatial_efficiency?.toFixed(3))}</span>
                    </div>
                    <div class="data-metric">
                        <span class="metric-name">Stroke Overlap Ratio:</span>
                        <span class="metric-value">${formatMetricValue(attempt.stroke_overlap_ratio?.toFixed(3), baseline.stroke_overlap_ratio?.toFixed(3))}</span>
                    </div>
                </div>`;
            
            // Security Indicators
            html += `
                <div class="data-group">
                    <div class="data-group-title">Security Indicators</div>
                    <div class="data-metric">
                        <span class="metric-name">Unnatural Pause Detection:</span>
                        <span class="metric-value">${formatMetricValue(attempt.unnatural_pause_detection?.toFixed(3), baseline.unnatural_pause_detection?.toFixed(3))}</span>
                    </div>
                    <div class="data-metric">
                        <span class="metric-name">Speed Anomaly Score:</span>
                        <span class="metric-value">${formatMetricValue(attempt.speed_anomaly_score?.toFixed(3), baseline.speed_anomaly_score?.toFixed(3))}</span>
                    </div>
                    <div class="data-metric">
                        <span class="metric-name">Pressure Anomaly Score:</span>
                        <span class="metric-value">${formatMetricValue(attempt.pressure_anomaly_score?.toFixed(3), baseline.pressure_anomaly_score?.toFixed(3))}</span>
                    </div>
                    <div class="data-metric">
                        <span class="metric-name">Timing Regularity Score:</span>
                        <span class="metric-value">${formatMetricValue(attempt.timing_regularity_score?.toFixed(3), baseline.timing_regularity_score?.toFixed(3))}</span>
                    </div>
                    <div class="data-metric">
                        <span class="metric-name">Device Consistency Score:</span>
                        <span class="metric-value">${formatMetricValue(attempt.device_consistency_score?.toFixed(3), baseline.device_consistency_score?.toFixed(3))}</span>
                    </div>
                    <div class="data-metric">
                        <span class="metric-name">Behavioral Authenticity Score:</span>
                        <span class="metric-value">${formatMetricValue(attempt.behavioral_authenticity_score?.toFixed(3), baseline.behavioral_authenticity_score?.toFixed(3))}</span>
                    </div>
                </div>`;
            
            // Component-Specific Features
            const componentType = attempt._component_type || 'signature';
            
            // Shape-specific features
            if (['circle', 'square', 'triangle'].includes(componentType)) {
                html += `
                    <div class="data-group">
                        <div class="data-group-title">Shape-Specific Features</div>`;
                
                if (attempt.start_position_analysis !== undefined) {
                    html += `
                        <div class="data-metric">
                            <span class="metric-name">Start Position Analysis:</span>
                            <span class="metric-value">${formatMetricValue(attempt.start_position_analysis?.toFixed(3), baseline.start_position_analysis?.toFixed(3))}</span>
                        </div>`;
                }
                
                if (attempt.closure_technique !== undefined) {
                    html += `
                        <div class="data-metric">
                            <span class="metric-name">Closure Technique:</span>
                            <span class="metric-value">${formatMetricValue(attempt.closure_technique?.toFixed(3), baseline.closure_technique?.toFixed(3))}</span>
                        </div>`;
                }
                
                if (attempt.corner_execution_pattern !== undefined) {
                    html += `
                        <div class="data-metric">
                            <span class="metric-name">Corner Execution Pattern:</span>
                            <span class="metric-value">${formatMetricValue(attempt.corner_execution_pattern?.toFixed(3), baseline.corner_execution_pattern?.toFixed(3))}</span>
                        </div>`;
                }
                
                html += `</div>`;
            }
            
            // Drawing-specific features
            if (['face', 'star', 'house', 'connect_dots'].includes(componentType)) {
                html += `
                    <div class="data-group">
                        <div class="data-group-title">Drawing-Specific Features</div>`;
                
                if (attempt.stroke_sequence_pattern !== undefined) {
                    html += `
                        <div class="data-metric">
                            <span class="metric-name">Stroke Sequence Pattern:</span>
                            <span class="metric-value">${formatMetricValue(attempt.stroke_sequence_pattern?.toFixed(3), baseline.stroke_sequence_pattern?.toFixed(3))}</span>
                        </div>`;
                }
                
                if (attempt.spatial_relationship_consistency !== undefined) {
                    html += `
                        <div class="data-metric">
                            <span class="metric-name">Spatial Relationship Consistency:</span>
                            <span class="metric-value">${formatMetricValue(attempt.spatial_relationship_consistency?.toFixed(3), baseline.spatial_relationship_consistency?.toFixed(3))}</span>
                        </div>`;
                }
                
                if (attempt.artistic_style_fingerprint !== undefined) {
                    html += `
                        <div class="data-metric">
                            <span class="metric-name">Artistic Style Fingerprint:</span>
                            <span class="metric-value">${formatMetricValue(attempt.artistic_style_fingerprint?.toFixed(3), baseline.artistic_style_fingerprint?.toFixed(3))}</span>
                        </div>`;
                }
                
                html += `</div>`;
            }
            
            return html;
        }
        
        // Render enhanced component features for shapes and drawings
        function renderEnhancedComponentFeatures(attempt, baseline) {
            // Check if we have enhanced features data
            const hasEnhancedShapes = attempt.shape_enhanced_features || attempt.shape_biometric_scores;
            const hasEnhancedDrawings = attempt.drawing_enhanced_features || attempt.drawing_biometric_scores;
            
            if (!hasEnhancedShapes && !hasEnhancedDrawings) {
                return '';
            }
            
            let html = '';
            
            // Enhanced Shape Features
            if (hasEnhancedShapes) {
                html += `
                    <div class="data-group">
                        <div class="data-group-title">Shape Biometric Analysis</div>`;
                
                // Show biometric vs geometric breakdown if available
                if (attempt.shape_biometric_scores) {
                    ['circle', 'square', 'triangle'].forEach(shape => {
                        if (attempt.shape_biometric_scores[shape]) {
                            const scores = attempt.shape_biometric_scores[shape];
                            html += `
                                <div class="data-metric">
                                    <span class="metric-name">${shape.charAt(0).toUpperCase() + shape.slice(1)} Biometric:</span>
                                    <span class="metric-value">B: ${formatPercentage(scores.biometric)}, G: ${formatPercentage(scores.geometric)}</span>
                                </div>`;
                        }
                    });
                }
                
                // Show specific enhanced features if available
                if (attempt.shape_enhanced_features) {
                    const features = attempt.shape_enhanced_features;
                    if (features.avg_pressure !== undefined) {
                        html += `
                            <div class="data-metric">
                                <span class="metric-name">Shape Pressure:</span>
                                <span class="metric-value">${formatMetricValue(features.avg_pressure?.toFixed(3), baseline.shape_avg_pressure?.toFixed(3))}</span>
                            </div>`;
                    }
                    if (features.tremor_index !== undefined) {
                        html += `
                            <div class="data-metric">
                                <span class="metric-name">Shape Tremor:</span>
                                <span class="metric-value">${formatMetricValue(features.tremor_index?.toFixed(3), baseline.shape_tremor_index?.toFixed(3))}</span>
                            </div>`;
                    }
                }
                
                html += `</div>`;
            }
            
            // Enhanced Drawing Features
            if (hasEnhancedDrawings) {
                html += `
                    <div class="data-group">
                        <div class="data-group-title">Drawing Biometric Analysis</div>`;
                
                // Show biometric vs geometric breakdown if available
                if (attempt.drawing_biometric_scores) {
                    ['face', 'star', 'house', 'connect_dots'].forEach(drawing => {
                        if (attempt.drawing_biometric_scores[drawing]) {
                            const scores = attempt.drawing_biometric_scores[drawing];
                            const drawingName = drawing === 'connect_dots' ? 'Connect Dots' : drawing.charAt(0).toUpperCase() + drawing.slice(1);
                            html += `
                                <div class="data-metric">
                                    <span class="metric-name">${drawingName} Biometric:</span>
                                    <span class="metric-value">B: ${formatPercentage(scores.biometric)}, G: ${formatPercentage(scores.geometric)}</span>
                                </div>`;
                        }
                    });
                }
                
                // Show specific enhanced features if available
                if (attempt.drawing_enhanced_features) {
                    const features = attempt.drawing_enhanced_features;
                    if (features.stroke_sequence_pattern !== undefined) {
                        html += `
                            <div class="data-metric">
                                <span class="metric-name">Stroke Pattern:</span>
                                <span class="metric-value">${formatMetricValue(features.stroke_sequence_pattern?.toFixed(3), baseline.drawing_stroke_pattern?.toFixed(3))}</span>
                            </div>`;
                    }
                    if (features.spatial_consistency !== undefined) {
                        html += `
                            <div class="data-metric">
                                <span class="metric-name">Spatial Consistency:</span>
                                <span class="metric-value">${formatMetricValue(features.spatial_consistency?.toFixed(3), baseline.drawing_spatial_consistency?.toFixed(3))}</span>
                            </div>`;
                    }
                }
                
                html += `</div>`;
            }
            
            // Enhanced Features Overview (if present)
            if (attempt._enhanced_features_enabled) {
                html += `
                    <div class="data-group">
                        <div class="data-group-title">Enhanced Feature Status</div>
                        <div class="data-metric">
                            <span class="metric-name">Enhanced Features:</span>
                            <span class="metric-value" style="color: #4caf50;">âœ“ Enabled</span>
                        </div>`;
                
                if (attempt._excluded_features && attempt._excluded_features.length > 0) {
                    html += `
                        <div class="data-metric">
                            <span class="metric-name">Excluded Features:</span>
                            <span class="metric-value">${attempt._excluded_features.join(', ')}</span>
                        </div>`;
                }
                
                if (attempt._feature_extraction_version) {
                    html += `
                        <div class="data-metric">
                            <span class="metric-name">Feature Version:</span>
                            <span class="metric-value">${attempt._feature_extraction_version}</span>
                        </div>`;
                }
                
                html += `</div>`;
            }
            
            return html;
        }

        // Render the Data tab
        function renderDataTab() {
            if (!currentData) return;
            
            const { baseline, authAttempts } = currentData;
            const attempts = authAttempts || [];
            
            let html = `
                <!-- Baseline Section -->
                <div class="baseline-section">
                    <div class="baseline-title">ðŸ“Š Baseline Reference (Enrollment + Verified Attempts)</div>
                    
                    <!-- Row 1: Main baseline data (5 columns) -->
                    <div class="baseline-grid baseline-grid-row1">
                        <div class="baseline-group">
                            <div class="group-title">Core Metrics</div>
                            <div class="metric-item">
                                <span>Stroke Count:</span>
                                <span>${baseline.stroke_count?.toFixed(1) || 'N/A'} avg</span>
                            </div>
                            <div class="metric-item">
                                <span>Total Points:</span>
                                <span>${baseline.total_points?.toFixed(1) || 'N/A'} avg</span>
                            </div>
                            <div class="metric-item">
                                <span>Duration (ms):</span>
                                <span>${baseline.total_duration_ms ? Math.round(baseline.total_duration_ms).toLocaleString() + ' avg' : 'N/A'}</span>
                            </div>
                            <div class="metric-item">
                                <span>Avg Velocity:</span>
                                <span>${baseline.avg_velocity?.toFixed(3) || 'N/A'} avg</span>
                            </div>
                            <div class="metric-item">
                                <span>Max Velocity:</span>
                                <span>${baseline.max_velocity?.toFixed(3) || 'N/A'} avg</span>
                            </div>
                            <div class="metric-item">
                                <span>Velocity Std:</span>
                                <span>${baseline.velocity_std?.toFixed(3) || 'N/A'} avg</span>
                            </div>
                        </div>

                        <div class="baseline-group">
                            <div class="group-title">Shape Metrics</div>
                            <div class="metric-item">
                                <span>Width:</span>
                                <span>${baseline.width ? Math.round(baseline.width) + ' avg' : 'N/A'}</span>
                            </div>
                            <div class="metric-item">
                                <span>Height:</span>
                                <span>${baseline.height ? Math.round(baseline.height) + ' avg' : 'N/A'}</span>
                            </div>
                            <div class="metric-item">
                                <span>Area:</span>
                                <span>${baseline.area ? Math.round(baseline.area).toLocaleString() + ' avg' : 'N/A'}</span>
                            </div>
                            <div class="metric-item">
                                <span>Aspect Ratio:</span>
                                <span>${baseline.aspect_ratio?.toFixed(2) || 'N/A'} avg</span>
                            </div>
                            <div class="metric-item">
                                <span>Center X:</span>
                                <span>${baseline.center_x ? Math.round(baseline.center_x) + ' avg' : 'N/A'}</span>
                            </div>
                            <div class="metric-item">
                                <span>Center Y:</span>
                                <span>${baseline.center_y ? Math.round(baseline.center_y) + ' avg' : 'N/A'}</span>
                            </div>
                        </div>

                        <div class="baseline-group">
                            <div class="group-title">Shapes</div>
                            <div class="metric-item">
                                <span>Circle Roundness:</span>
                                <span>${baseline.circle_roundness ? formatPercentage(baseline.circle_roundness) + ' avg' : 'N/A'}</span>
                            </div>
                            <div class="metric-item">
                                <span>Square Corners:</span>
                                <span>${baseline.square_corner_accuracy ? formatPercentage(baseline.square_corner_accuracy) + ' avg' : 'N/A'}</span>
                            </div>
                            <div class="metric-item">
                                <span>Triangle Closure:</span>
                                <span>${baseline.triangle_closure ? formatPercentage(baseline.triangle_closure) + ' avg' : 'N/A'}</span>
                            </div>
                        </div>

                        <div class="baseline-group">
                            <div class="group-title">Drawings</div>
                            <div class="metric-item">
                                <span>Face Features:</span>
                                <span>${baseline.face_score ? formatPercentage(baseline.face_score) + ' avg' : 'N/A'}</span>
                            </div>
                            <div class="metric-item">
                                <span>Star Points:</span>
                                <span>${baseline.star_score ? formatPercentage(baseline.star_score) + ' avg' : 'N/A'}</span>
                            </div>
                            <div class="metric-item">
                                <span>House Structure:</span>
                                <span>${baseline.house_score ? formatPercentage(baseline.house_score) + ' avg' : 'N/A'}</span>
                            </div>
                            <div class="metric-item">
                                <span>Connect Dots:</span>
                                <span>${baseline.connect_dots_score ? formatPercentage(baseline.connect_dots_score) + ' avg' : 'N/A'}</span>
                            </div>
                        </div>

                        <div class="baseline-group">
                            <div class="group-title">Additional Metrics</div>
                            <div class="metric-item">
                                <span>Stroke Length Avg:</span>
                                <span>${baseline.avg_stroke_length?.toFixed(1) || 'N/A'} avg</span>
                            </div>
                            <div class="metric-item">
                                <span>Stroke Length Std:</span>
                                <span>${baseline.length_variation?.toFixed(1) || 'N/A'} avg</span>
                            </div>
                            <div class="metric-item">
                                <span>Pressure Avg:</span>
                                <span>${baseline._excluded_features?.includes('avg_pressure') ? 'N/A' : (baseline.avg_pressure?.toFixed(2) || 'N/A')} avg</span>
                            </div>
                            <div class="metric-item">
                                <span>Pause Count:</span>
                                <span>${baseline.pause_detection?.toFixed(0) || 'N/A'} avg</span>
                            </div>
                            <div class="metric-item">
                                <span>Direction Changes:</span>
                                <span>${baseline.direction_changes?.toFixed(1) || 'N/A'} avg</span>
                            </div>
                        </div>
                    </div>

                    <!-- Row 2: Enhanced Biometric Features (4 columns) -->
                    <div class="baseline-grid baseline-grid-row2">
                        <div class="baseline-group">
                            <div class="group-title">Pressure Analysis</div>
                            <div class="metric-item">
                                <span>Avg Pressure:</span>
                                <span>${baseline._excluded_features?.includes('avg_pressure') ? 'Not supported' : (baseline.avg_pressure?.toFixed(2) + ' avg' || 'N/A')}</span>
                            </div>
                            <div class="metric-item">
                                <span>Max Pressure:</span>
                                <span>${baseline._excluded_features?.includes('max_pressure') ? 'Not supported' : (baseline.max_pressure?.toFixed(2) + ' avg' || 'N/A')}</span>
                            </div>
                            <div class="metric-item">
                                <span>Min Pressure:</span>
                                <span>${baseline._excluded_features?.includes('min_pressure') ? 'Not supported' : (baseline.min_pressure?.toFixed(2) + ' avg' || 'N/A')}</span>
                            </div>
                            <div class="metric-item">
                                <span>Pressure Std:</span>
                                <span>${baseline._excluded_features?.includes('pressure_std') ? 'Not supported' : (baseline.pressure_std?.toFixed(2) + ' avg' || 'N/A')}</span>
                            </div>
                            <div class="metric-item">
                                <span>Pressure Range:</span>
                                <span>${baseline._excluded_features?.includes('pressure_range') ? 'Not supported' : (baseline.pressure_range?.toFixed(2) + ' avg' || 'N/A')}</span>
                            </div>
                            <div class="metric-item">
                                <span>Contact Time Ratio:</span>
                                <span>${baseline._excluded_features?.includes('contact_time_ratio') ? 'Not supported' : (baseline.contact_time_ratio?.toFixed(2) + ' avg' || 'N/A')}</span>
                            </div>
                            <div class="metric-item">
                                <span>Pressure Buildup Rate:</span>
                                <span>${baseline._excluded_features?.includes('pressure_buildup_rate') ? 'Not supported' : (baseline.pressure_buildup_rate?.toFixed(2) + ' avg' || 'N/A')}</span>
                            </div>
                            <div class="metric-item">
                                <span>Pressure Release Rate:</span>
                                <span>${baseline._excluded_features?.includes('pressure_release_rate') ? 'Not supported' : (baseline.pressure_release_rate?.toFixed(2) + ' avg' || 'N/A')}</span>
                            </div>
                        </div>

                        <div class="baseline-group">
                            <div class="group-title">Behavioral Timing</div>
                            <div class="metric-item">
                                <span>Pause Count:</span>
                                <span>${baseline.pause_detection?.toFixed(0) || 'N/A'} avg</span>
                            </div>
                            <div class="metric-item">
                                <span>Rhythm Consistency:</span>
                                <span>${baseline.rhythm_consistency?.toFixed(1) || 'N/A'} avg</span>
                            </div>
                            <div class="metric-item">
                                <span>Tempo Variation:</span>
                                <span>${baseline.tempo_variation?.toFixed(1) || 'N/A'} avg</span>
                            </div>
                            <div class="metric-item">
                                <span>Dwell Time Patterns:</span>
                                <span>${baseline.dwell_time_patterns?.toFixed(1) || 'N/A'} avg</span>
                            </div>
                            <div class="metric-item">
                                <span>Inter Stroke Timing:</span>
                                <span>${baseline.inter_stroke_timing?.toFixed(1) || 'N/A'} ms avg</span>
                            </div>
                            <div class="metric-item">
                                <span>Total Duration:</span>
                                <span>${baseline.drawing_duration_total ? Math.round(baseline.drawing_duration_total).toLocaleString() + ' ms avg' : 'N/A'}</span>
                            </div>
                            <div class="metric-item">
                                <span>Pause Time Ratio:</span>
                                <span>${baseline.pause_time_ratio?.toFixed(2) || 'N/A'} avg</span>
                            </div>
                            <div class="metric-item">
                                <span>Avg Stroke Duration:</span>
                                <span>${baseline.avg_stroke_duration?.toFixed(1) || 'N/A'} ms avg</span>
                            </div>
                        </div>

                        <div class="baseline-group">
                            <div class="group-title">Geometric Complexity</div>
                            <div class="metric-item">
                                <span>Stroke Complexity:</span>
                                <span>${baseline.stroke_complexity?.toFixed(2) || 'N/A'} avg</span>
                            </div>
                            <div class="metric-item">
                                <span>Tremor Index:</span>
                                <span>${baseline.tremor_index?.toFixed(2) || 'N/A'} avg</span>
                            </div>
                            <div class="metric-item">
                                <span>Smoothness Index:</span>
                                <span>${baseline.smoothness_index?.toFixed(2) || 'N/A'} avg</span>
                            </div>
                            <div class="metric-item">
                                <span>Direction Changes:</span>
                                <span>${baseline.direction_changes?.toFixed(1) || 'N/A'} avg</span>
                            </div>
                            <div class="metric-item">
                                <span>Curvature Analysis:</span>
                                <span>${baseline.curvature_analysis?.toFixed(3) || 'N/A'} avg</span>
                            </div>
                            <div class="metric-item">
                                <span>Spatial Efficiency:</span>
                                <span>${baseline.spatial_efficiency?.toFixed(1) || 'N/A'} avg</span>
                            </div>
                            <div class="metric-item">
                                <span>Stroke Overlap Ratio:</span>
                                <span>${baseline.stroke_overlap_ratio?.toFixed(3) || 'N/A'} avg</span>
                            </div>
                        </div>

                        <div class="baseline-group">
                            <div class="group-title">Security Indicators</div>
                            <div class="metric-item">
                                <span>Unnatural Pause Detection:</span>
                                <span>${baseline.unnatural_pause_detection?.toFixed(3) || '0.000'} avg</span>
                            </div>
                            <div class="metric-item">
                                <span>Speed Anomaly Score:</span>
                                <span>${baseline.speed_anomaly_score?.toFixed(2) || 'N/A'} avg</span>
                            </div>
                            <div class="metric-item">
                                <span>Pressure Anomaly Score:</span>
                                <span>${baseline._excluded_features?.includes('pressure_anomaly_score') ? 'Not supported' : (baseline.pressure_anomaly_score?.toFixed(3) || '0.000') + ' avg'}</span>
                            </div>
                            <div class="metric-item">
                                <span>Timing Regularity Score:</span>
                                <span>${baseline.timing_regularity_score?.toFixed(2) || 'N/A'} avg</span>
                            </div>
                            <div class="metric-item">
                                <span>Device Consistency Score:</span>
                                <span>${baseline.device_consistency_score?.toFixed(2) || 'N/A'} avg</span>
                            </div>
                            <div class="metric-item">
                                <span>Behavioral Authenticity Score:</span>
                                <span>${baseline.behavioral_authenticity_score?.toFixed(2) || 'N/A'} avg</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Authentication Attempts -->
                <div class="auth-attempts">
            `;
            
            // Render each attempt
            attempts.forEach((attempt, index) => {
                const attemptNumber = attempts.length - index;
                const status = attempt.authentication_result === 'success' ? 'PASSED' : 'FAILED';
                const statusClass = attempt.authentication_result === 'success' ? 'status-passed' : 'status-failed';
                
                html += `
                    <div class="attempt-card">
                        <div class="attempt-header">
                            <div class="attempt-info">
                                <div class="attempt-title">Attempt #${attemptNumber}</div>
                                <div class="attempt-meta">${formatTimestamp(attempt.timestamp)} â€¢ ${attempt.device_type || 'Unknown'} â€¢ ${attempt.browser || 'Unknown'}</div>
                            </div>
                            <div class="attempt-result">
                                <span class="${statusClass}">${status}</span>
                                <span>${formatPercentage(attempt.signature_score)}</span>
                            </div>
                        </div>
                        
                        <div class="attempt-data">
                            <div class="data-group">
                                <div class="data-group-title">Core Metrics</div>
                                <div class="data-metric">
                                    <span class="metric-name">Stroke Count:</span>
                                    <span class="metric-value">${formatMetricValue(attempt.stroke_count, baseline.stroke_count)}</span>
                                </div>
                                <div class="data-metric">
                                    <span class="metric-name">Total Points:</span>
                                    <span class="metric-value">${formatMetricValue(attempt.total_points, baseline.total_points)}</span>
                                </div>
                                <div class="data-metric">
                                    <span class="metric-name">Duration (ms):</span>
                                    <span class="metric-value">${formatMetricValue(Math.round(attempt.total_duration_ms), baseline.total_duration_ms ? Math.round(baseline.total_duration_ms) : null)}</span>
                                </div>
                                <div class="data-metric">
                                    <span class="metric-name">Avg Velocity:</span>
                                    <span class="metric-value">${formatMetricValue(attempt.avg_velocity?.toFixed(3), baseline.avg_velocity?.toFixed(3))}</span>
                                </div>
                                <div class="data-metric">
                                    <span class="metric-name">Max Velocity:</span>
                                    <span class="metric-value">${formatMetricValue(attempt.max_velocity?.toFixed(3), baseline.max_velocity?.toFixed(3))}</span>
                                </div>
                                <div class="data-metric">
                                    <span class="metric-name">Velocity Std:</span>
                                    <span class="metric-value">${formatMetricValue(attempt.velocity_std?.toFixed(3), baseline.velocity_std?.toFixed(3))}</span>
                                </div>
                            </div>

                            <div class="data-group">
                                <div class="data-group-title">Shape Analysis</div>
                                <div class="data-metric">
                                    <span class="metric-name">Width:</span>
                                    <span class="metric-value">${formatMetricValue(Math.round(attempt.width), Math.round(baseline.width))}</span>
                                </div>
                                <div class="data-metric">
                                    <span class="metric-name">Height:</span>
                                    <span class="metric-value">${formatMetricValue(Math.round(attempt.height), Math.round(baseline.height))}</span>
                                </div>
                                <div class="data-metric">
                                    <span class="metric-name">Area:</span>
                                    <span class="metric-value">${formatMetricValue(Math.round(attempt.area), Math.round(baseline.area))}</span>
                                </div>
                                <div class="data-metric">
                                    <span class="metric-name">Aspect Ratio:</span>
                                    <span class="metric-value">${formatMetricValue(attempt.aspect_ratio?.toFixed(2), baseline.aspect_ratio?.toFixed(2))}</span>
                                </div>
                                <div class="data-metric">
                                    <span class="metric-name">Center X:</span>
                                    <span class="metric-value">${formatMetricValue(Math.round(attempt.center_x), baseline.center_x ? Math.round(baseline.center_x) : null)}</span>
                                </div>
                                <div class="data-metric">
                                    <span class="metric-name">Center Y:</span>
                                    <span class="metric-value">${formatMetricValue(Math.round(attempt.center_y), baseline.center_y ? Math.round(baseline.center_y) : null)}</span>
                                </div>
                            </div>

                            <div class="data-group">
                                <div class="data-group-title">Shapes Performance</div>
                                <div class="data-metric">
                                    <span class="metric-name">Circle Score:</span>
                                    <span class="metric-value">${formatPercentage(attempt.shape_scores?.circle)} (Roundness: ${formatMetricValue(attempt.circle_roundness, baseline.circle_roundness, false)}%)</span>
                                </div>
                                <div class="data-metric">
                                    <span class="metric-name">Square Score:</span>
                                    <span class="metric-value">${formatPercentage(attempt.shape_scores?.square)} (Corners: ${formatMetricValue(attempt.square_corner_accuracy, baseline.square_corner_accuracy, false)}%)</span>
                                </div>
                                <div class="data-metric">
                                    <span class="metric-name">Triangle Score:</span>
                                    <span class="metric-value">${formatPercentage(attempt.shape_scores?.triangle)} (Closure: ${formatMetricValue(attempt.triangle_closure, baseline.triangle_closure, false)}%)</span>
                                </div>
                            </div>

                            <div class="data-group">
                                <div class="data-group-title">Drawings Performance</div>
                                <div class="data-metric">
                                    <span class="metric-name">Face Score:</span>
                                    <span class="metric-value">${formatPercentage(attempt.drawing_scores?.face)}</span>
                                </div>
                                <div class="data-metric">
                                    <span class="metric-name">Star Score:</span>
                                    <span class="metric-value">${formatPercentage(attempt.drawing_scores?.star)}</span>
                                </div>
                                <div class="data-metric">
                                    <span class="metric-name">House Score:</span>
                                    <span class="metric-value">${attempt.drawing_scores?.house !== null && attempt.drawing_scores?.house !== undefined ? formatPercentage(attempt.drawing_scores.house) : 'N/A'}</span>
                                </div>
                                <div class="data-metric">
                                    <span class="metric-name">Connect Dots:</span>
                                    <span class="metric-value">${attempt.drawing_scores?.connect_dots !== null && attempt.drawing_scores?.connect_dots !== undefined ? formatPercentage(attempt.drawing_scores.connect_dots) : 'N/A'}</span>
                                </div>
                            </div>
                            
                            ${renderEnhancedComponentFeatures(attempt, baseline)}
                            
                            ${renderComprehensiveEnhancedFeatures(attempt, baseline)}

                            <div class="data-group">
                                <div class="data-group-title">Additional Metrics</div>
                                <div class="data-metric">
                                    <span class="metric-name">Stroke Length Avg:</span>
                                    <span class="metric-value">${formatMetricValue(attempt.avg_stroke_length?.toFixed(1), baseline.avg_stroke_length?.toFixed(1))}</span>
                                </div>
                                <div class="data-metric">
                                    <span class="metric-name">Stroke Length Std:</span>
                                    <span class="metric-value">${formatMetricValue(attempt.length_variation?.toFixed(1), baseline.length_variation?.toFixed(1))}</span>
                                </div>
                            </div>

                            <div class="data-group">
                                <div class="data-group-title">Device & Context</div>
                                <div class="data-metric">
                                    <span class="metric-name">Device Type:</span>
                                    <span class="metric-value">${attempt.device_type || 'Unknown'}</span>
                                </div>
                                <div class="data-metric">
                                    <span class="metric-name">Browser:</span>
                                    <span class="metric-value">${attempt.browser || 'Unknown'}</span>
                                </div>
                                <div class="data-metric">
                                    <span class="metric-name">Input Method:</span>
                                    <span class="metric-value">${attempt.input_method || 'Unknown'}</span>
                                </div>
                                <div class="data-metric">
                                    <span class="metric-name">Canvas Coverage:</span>
                                    <span class="metric-value">${formatPercentage(attempt.canvas_coverage)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            document.getElementById('dataTab').innerHTML = html;
        }

        // Draw strokes on canvas
        function drawStrokesOnCanvas(canvas, strokeData) {
            if (!strokeData || !Array.isArray(strokeData)) return;
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Find bounds
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
            strokeData.forEach(stroke => {
                stroke.points.forEach(point => {
                    minX = Math.min(minX, point.x);
                    minY = Math.min(minY, point.y);
                    maxX = Math.max(maxX, point.x);
                    maxY = Math.max(maxY, point.y);
                });
            });
            
            // Calculate scale to fit canvas
            const padding = 10;
            const scaleX = (canvas.width - 2 * padding) / (maxX - minX || 1);
            const scaleY = (canvas.height - 2 * padding) / (maxY - minY || 1);
            const scale = Math.min(scaleX, scaleY);
            
            // Center the drawing
            const offsetX = (canvas.width - (maxX - minX) * scale) / 2;
            const offsetY = (canvas.height - (maxY - minY) * scale) / 2;
            
            // Draw strokes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            strokeData.forEach(stroke => {
                if (stroke.points.length < 2) return;
                
                ctx.beginPath();
                stroke.points.forEach((point, index) => {
                    const x = (point.x - minX) * scale + offsetX;
                    const y = (point.y - minY) * scale + offsetY;
                    
                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                });
                ctx.stroke();
            });
        }

        // Render the Images tab
        function renderImagesTab() {
            if (!currentData) return;
            
            const { enrollment } = currentData;
            
            let html = `
                <div class="images-layout">
                    <!-- Baseline Images -->
                    <div class="baseline-images">
                        <div class="baseline-images-title">ðŸŽ¯ Enrollment Images</div>
            `;
            
            // Enrollment signatures
            if (enrollment.signatures && enrollment.signatures.length > 0) {
                html += `
                    <div class="image-group">
                        <div class="image-group-title">Signatures (${enrollment.signatures.length} enrollment samples)</div>
                        <div class="image-grid">
                `;
                
                enrollment.signatures.forEach((sig, index) => {
                    html += `
                        <div class="image-item">
                            <canvas class="image-canvas" id="enrollment-sig-${index}"></canvas>
                            <div class="image-label">Signature ${index + 1}</div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            // Enrollment shapes
            if (enrollment.shapes && enrollment.shapes.length > 0) {
                html += `
                    <div class="image-group">
                        <div class="image-group-title">Shapes</div>
                        <div class="image-grid">
                `;
                
                enrollment.shapes.forEach((shape, index) => {
                    html += `
                        <div class="image-item">
                            <canvas class="image-canvas" id="enrollment-shape-${index}"></canvas>
                            <div class="image-label">${shape.shape_type.charAt(0).toUpperCase() + shape.shape_type.slice(1)}</div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            // Enrollment drawings
            if (enrollment.drawings && enrollment.drawings.length > 0) {
                html += `
                    <div class="image-group">
                        <div class="image-group-title">Drawings</div>
                        <div class="image-grid">
                `;
                
                enrollment.drawings.forEach((drawing, index) => {
                    html += `
                        <div class="image-item">
                            <canvas class="image-canvas" id="enrollment-drawing-${index}"></canvas>
                            <div class="image-label">${drawing.drawing_type.split('_').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')}</div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            html += `
                    </div>

                    <!-- Authentication Attempt Images -->
                    <div class="auth-images">
                        <div class="auth-images-title">ðŸ“‹ Authentication Attempts</div>
            `;
            
            // Attempt images
            // The original code had a loop for authAttempts, but the new HTML structure
            // for the images tab is different. This part of the script needs to be
            // updated to reflect the new HTML structure.
            // For now, we'll just show a placeholder or remove if not directly applicable.
            // Given the new HTML structure, the attempt images are now part of the
            // enrollment data or a separate section if needed.
            // For simplicity, we'll remove the attempt image rendering as it's not
            // directly tied to the enrollment data in the new HTML structure.
            // If the intent was to show attempts, the HTML structure would need to be
            // changed to include a separate section for attempts.
            // For now, we'll just render the enrollment images.
            
            html += `
                    </div>
                </div>
            `;
            
            document.getElementById('imagesTab').innerHTML = html;
            
            // Draw all canvases after DOM update
            setTimeout(() => {
                // Draw enrollment images
                if (enrollment) {
                    // Signatures
                    if (enrollment.signatures) {
                        enrollment.signatures.forEach((sig, index) => {
                            const canvas = document.getElementById(`enrollment-sig-${index}`);
                            if (canvas) {
                                // Handle different signature data formats
                                if (typeof sig.signature_data === 'string' && sig.signature_data.startsWith('data:image')) {
                                    // Base64 image
                                    const img = new Image();
                                    img.onload = () => {
                                        const ctx = canvas.getContext('2d');
                                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                                    };
                                    img.src = sig.signature_data;
                                } else {
                                    // Stroke data
                                    drawStrokesOnCanvas(canvas, sig.signature_data);
                                }
                            }
                        });
                    }
                    
                    // Shapes
                    if (enrollment.shapes) {
                        enrollment.shapes.forEach((shape, index) => {
                            const canvas = document.getElementById(`enrollment-shape-${index}`);
                            if (canvas) {
                                if (typeof shape.shape_data === 'string' && shape.shape_data.startsWith('data:image')) {
                                    // Base64 image
                                    const img = new Image();
                                    img.onload = () => {
                                        const ctx = canvas.getContext('2d');
                                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                                    };
                                    img.src = shape.shape_data;
                                } else {
                                    // Stroke data
                                    drawStrokesOnCanvas(canvas, shape.shape_data);
                                }
                            }
                        });
                    }
                    
                    // Drawings
                    if (enrollment.drawings) {
                        enrollment.drawings.forEach((drawing, index) => {
                            const canvas = document.getElementById(`enrollment-drawing-${index}`);
                            if (canvas) {
                                if (typeof drawing.drawing_data === 'string' && drawing.drawing_data.startsWith('data:image')) {
                                    // Base64 image
                                    const img = new Image();
                                    img.onload = () => {
                                        const ctx = canvas.getContext('2d');
                                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                                    };
                                    img.src = drawing.drawing_data;
                                } else {
                                    // Stroke data
                                    drawStrokesOnCanvas(canvas, drawing.drawing_data);
                                }
                            }
                        });
                    }
                }
            }, 100);
        }

        // Render the Raw tab
        function renderRawTab() {
            if (!currentData) return;
            
            // Create sections for enrollment data and authentication attempts
            const enrollmentData = {
                baseline: currentData.baseline,
                enrollment: currentData.enrollment
            };
            
            const authAttemptsData = {
                attempts: currentData.authAttempts,
                attemptCount: currentData.authAttempts ? currentData.authAttempts.length : 0
            };
            
            const html = `
                <div class="raw-section">
                    <h2 class="raw-section-title">ðŸ“‹ Enrollment Data</h2>
                    <div class="raw-json">
                        <pre>${JSON.stringify(enrollmentData, null, 2)}</pre>
                    </div>
                </div>
                
                <div class="raw-section">
                    <h2 class="raw-section-title">ðŸ” Authentication Attempts</h2>
                    <div class="raw-json">
                        <pre>${JSON.stringify(authAttemptsData, null, 2)}</pre>
                    </div>
                </div>
            `;
            
            document.getElementById('rawTab').innerHTML = html;
        }

        // Tab switching
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>