<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Signature Auth - Enhanced</title>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            max-width: 500px;
            width: 90%;
            margin: 20px;
        }
        
        h1 { 
            text-align: center; 
            color: #333;
            margin-bottom: 10px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        /* Progress indicator */
        .progress-container {
            margin-bottom: 30px;
        }
        
        .progress-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            border-radius: 4px;
        }
        
        .progress-text {
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
        
        /* Canvas styling */
        #signature-pad { 
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            width: 100%;
            touch-action: none;
            background-color: #fafafa;
            margin: 20px 0;
            cursor: crosshair;
            transition: border-color 0.3s;
        }
        
        #signature-pad:hover {
            border-color: #667eea;
        }
        
        /* Instructions */
        .instructions {
            background: #f5f3ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
            font-size: 14px;
            color: #4a5568;
        }
        
        .drawing-prompt {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin: 20px 0;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        /* Consistency indicator */
        .consistency-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 15px 0;
            padding: 10px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .consistency-good {
            background: #d4f4dd;
            color: #1e7e34;
        }
        
        .consistency-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .consistency-poor {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* Buttons */
        button { 
            width: 100%;
            margin: 10px 0; 
            padding: 15px;
            font-size: 16px;
            border-radius: 10px;
            cursor: pointer;
            border: none;
            font-weight: 600;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        .primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .primary:hover {
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .secondary {
            background: #e0e0e0;
            color: #333;
        }
        
        .secondary:hover {
            background: #d0d0d0;
        }
        
        .clear {
            background: transparent;
            border: 2px solid #e0e0e0;
            color: #666;
        }
        
        .clear:hover {
            border-color: #667eea;
            color: #667eea;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Sample display */
        .samples-container {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .sample-box {
            width: 80px;
            height: 80px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            position: relative;
            background: #fafafa;
            transition: all 0.3s;
        }
        
        .sample-box.completed {
            border-color: #667eea;
            background: #f5f3ff;
        }
        
        .sample-box.completed::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #667eea;
            font-size: 24px;
            font-weight: bold;
        }
        
        /* Input field */
        input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        /* Messages */
        .message {
            padding: 15px;
            margin: 15px 0;
            border-radius: 10px;
            text-align: center;
            font-weight: 500;
            animation: slideIn 0.3s ease;
            position: relative;  /* Add this */
            z-index: 100;       /* Add this */
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .success {
            background: #d4f4dd;
            color: #1e7e34;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* Fix message overlap */
        #message {
            position: relative;
            z-index: 1000;
            margin-top: 20px;  /* Add space */
        }
        
        /* Also update the retry button to not overlap */
        #next {
            position: relative;
            z-index: 999;
        }
        
        /* Loading spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Stage indicator */
        .stage-indicator {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
        }
        
        .stage {
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0.5;
            transition: opacity 0.3s;
        }
        
        .stage.active {
            opacity: 1;
        }
        
        .stage-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 5px;
            transition: all 0.3s;
        }
        
        .stage.active .stage-icon {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .stage.completed .stage-icon {
            background: #4caf50;
            color: white;
        }
        
        .stage-label {
            font-size: 12px;
            color: #666;
        }
        
        /* Mobile optimizations */
        @media (max-width: 600px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            button {
                padding: 12px;
            }
            
            .stage-indicator {
                gap: 15px;
            }
            
            .stage-icon {
                width: 40px;
                height: 40px;
                font-size: 20px;
            }
        }
        
        /* Fullscreen mode */
        .fullscreen-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .fullscreen-canvas {
            width: 90%;
            max-width: 800px;
            height: 60vh;
            border: 3px solid #667eea;
            border-radius: 20px;
            background: #fafafa;
        }
        
        .fullscreen-controls {
            margin-top: 20px;
            display: flex;
            gap: 15px;
        }
        
        /* Skip button for returning users */
        .skip-intro {
            text-align: center;
            margin-top: 10px;
        }
        
        .skip-intro a {
            color: #667eea;
            text-decoration: none;
            font-size: 14px;
        }
        
        .skip-intro a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container" id="mainContainer">
        <h1 id="title">Secure Sign-Up</h1>
        <p class="subtitle" id="subtitle">Let's set up your unique authentication</p>
        
        <!-- Progress bar -->
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
            <div class="progress-text" id="progressText">Getting started...</div>
        </div>
        
        <!-- Stage indicator -->
        <div class="stage-indicator" id="stageIndicator">
            <div class="stage active" id="stage1">
                <div class="stage-icon">✍️</div>
                <div class="stage-label">Signature</div>
            </div>
            <div class="stage" id="stage2">
                <div class="stage-icon">⭕</div>
                <div class="stage-label">Shapes</div>
            </div>
            <div class="stage" id="stage3">
                <div class="stage-icon">🎨</div>
                <div class="stage-label">Drawings</div>
            </div>
        </div>
        
        <!-- Username input (only shown initially) -->
        <input type="text" id="username" placeholder="Choose your username" style="display: none;">
        
        <!-- Instructions -->
        <div class="instructions" id="instructions">
            Welcome! We'll guide you through setting up your secure signature authentication.
        </div>
        
        <!-- Drawing prompt (hidden initially) -->
        <div class="drawing-prompt" id="drawingPrompt" style="display: none;"></div>
        
        <!-- Signature/Drawing pad -->
        <canvas id="signature-pad" width="400" height="200"></canvas>
        
        <!-- Consistency indicator -->
        <div class="consistency-indicator" id="consistencyIndicator" style="display: none;">
            Checking consistency...
        </div>
        
        <!-- Sample boxes -->
        <div class="samples-container" id="samplesContainer" style="display: none;">
            <div class="sample-box" id="sample1"></div>
            <div class="sample-box" id="sample2"></div>
            <div class="sample-box" id="sample3"></div>
            <div class="sample-box" id="sample4"></div>
            <div class="sample-box" id="sample5"></div>
        </div>
        
        <!-- Buttons -->
        <button class="clear" id="clear">Clear</button>
        <button class="primary" id="next">Next</button>
        
        <div id="message"></div>
        
        <div class="skip-intro" id="skipIntro">
            <a href="#" id="skipLink">Already have an account? Sign in</a>
        </div>
    </div>
    
    <!-- Load signature_pad library -->
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    
    <script>
        // Configuration
        const API_URL = 'https://chickenscratch.onrender.com';
        const ML_API_URL = 'https://chickenscratch.onrender.com';
        
        // Drawing challenges pool
        const drawingChallenges = {
            shapes: [
                { prompt: "Draw a circle", type: "shape", validation: "circle" },
                { prompt: "Draw a square", type: "shape", validation: "square" },
                { prompt: "Draw a triangle", type: "shape", validation: "triangle" }
            ],
            creative: [
                { prompt: "Draw 3 shapes of different sizes", type: "creative", validation: "multiple_shapes" },
                { prompt: "Draw an arrow", type: "creative", validation: "arrow" },
                { prompt: "Draw a simple face", type: "creative", validation: "face" },
                { prompt: "Draw a star", type: "creative", validation: "star" },
                { prompt: "Draw the first letter of your name", type: "creative", validation: "letter" },
                { prompt: "Draw a house", type: "creative", validation: "house" },
                { prompt: "Connect these 4 dots", type: "creative", validation: "dots" }
            ]
        };
        
        // State management
        const state = {
            mode: 'enrollment', // 'enrollment' or 'authentication'
            currentStage: 1,
            currentSample: 0,
            samples: {
                signatures: [],
                shapes: [],
                drawings: []
            },
            username: '',
            enrollmentData: {
                signatures: [],
                shapes: {},
                drawings: {}
            },
            consistency: {
                signatures: [],
                current: 0
            },
            selectedChallenges: [],
            userConfidence: 0
        };
        
        // Initialize signature pad
        const canvas = document.getElementById('signature-pad');
        const signaturePad = new SignaturePad(canvas, {
            minWidth: 0.5,
            maxWidth: 2.5,
            throttle: 16,
            minDistance: 5,
            backgroundColor: '#fafafa',
            penColor: '#333333'
        });
        
        // Track drawing metrics
        let drawingMetrics = {
            startTime: null,
            strokeCount: 0,
            totalDistance: 0,
            averageSpeed: 0,
            points: []
        };
        
        // Signature pad event listeners
        signaturePad.addEventListener("beginStroke", () => {
            if (!drawingMetrics.startTime) {
                drawingMetrics.startTime = Date.now();
            }
            drawingMetrics.strokeCount++;
            
            // Haptic feedback on mobile
            if ('vibrate' in navigator) {
                navigator.vibrate(10);
            }
        });
        
        signaturePad.addEventListener("endStroke", () => {
            // Stroke ended - no undo functionality needed
        });
        
        // Calculate drawing metrics
        function calculateMetrics() {
            const data = signaturePad.toData();
            let totalPoints = 0;
            let totalDistance = 0;
            
            data.forEach(stroke => {
                totalPoints += stroke.points.length;
                for (let i = 1; i < stroke.points.length; i++) {
                    const p1 = stroke.points[i - 1];
                    const p2 = stroke.points[i];
                    const distance = Math.sqrt(
                        Math.pow(p2.x - p1.x, 2) + Math.pow(p2.y - p1.y, 2)
                    );
                    totalDistance += distance;
                }
            });
            
            const duration = drawingMetrics.startTime ? Date.now() - drawingMetrics.startTime : 0;
            const averageSpeed = duration > 0 ? totalDistance / duration : 0;
            
            return {
                strokeCount: drawingMetrics.strokeCount,
                totalPoints,
                totalDistance: Math.round(totalDistance),
                duration,
                averageSpeed: averageSpeed.toFixed(3),
                timestamp: Date.now()
            };
        }
        
        // Consistency checking
        function checkSignatureConsistency(newSig, previousSigs) {
            if (previousSigs.length === 0) return 1.0;
            
            // Simple consistency check based on metrics
            const metrics = calculateMetrics();
            const avgPrevious = previousSigs.reduce((acc, sig) => {
                return {
                    strokeCount: acc.strokeCount + sig.metrics.strokeCount,
                    totalDistance: acc.totalDistance + sig.metrics.totalDistance,
                    duration: acc.duration + sig.metrics.duration
                };
            }, { strokeCount: 0, totalDistance: 0, duration: 0 });
            
            // Calculate averages
            const count = previousSigs.length;
            avgPrevious.strokeCount /= count;
            avgPrevious.totalDistance /= count;
            avgPrevious.duration /= count;
            
            // Calculate similarity scores
            const strokeSimilarity = 1 - Math.abs(metrics.strokeCount - avgPrevious.strokeCount) / Math.max(metrics.strokeCount, avgPrevious.strokeCount);
            const distanceSimilarity = 1 - Math.abs(metrics.totalDistance - avgPrevious.totalDistance) / Math.max(metrics.totalDistance, avgPrevious.totalDistance);
            const durationSimilarity = 1 - Math.abs(metrics.duration - avgPrevious.duration) / Math.max(metrics.duration, avgPrevious.duration);
            
            // Weighted average
            return (strokeSimilarity * 0.3 + distanceSimilarity * 0.4 + durationSimilarity * 0.3);
        }
        
        // Update consistency indicator
        function updateConsistencyIndicator(score) {
            const indicator = document.getElementById('consistencyIndicator');
            indicator.style.display = 'flex';
            
            if (score > 0.8) {
                indicator.className = 'consistency-indicator consistency-good';
                indicator.innerHTML = '✓ Great consistency!';
            } else if (score > 0.6) {
                indicator.className = 'consistency-indicator consistency-warning';
                indicator.innerHTML = '⚠ Try to match your previous signature';
            } else {
                indicator.className = 'consistency-indicator consistency-poor';
                indicator.innerHTML = '✗ Too different - try to sign more consistently';
            }
            
            // Hide after 3 seconds
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 3000);
        }
        
        // Progress management
        function updateProgress() {
            const totalSteps = state.mode === 'enrollment' ? 11 : 5; // Changed from 15 to 11 (3 sigs + 3 shapes + 5 drawings)
            let completedSteps = 0;
            
            if (state.currentStage === 1) {
                completedSteps = state.samples.signatures.length;
            } else if (state.currentStage === 2) {
                completedSteps = 3 + state.samples.shapes.length;  // Changed from 5 to 3
            } else if (state.currentStage === 3) {
                completedSteps = 6 + state.samples.drawings.length;  // Changed from 10 to 6
            }
            
            const percentage = (completedSteps / totalSteps) * 100;
            document.getElementById('progressFill').style.width = `${percentage}%`;
            
            // Update progress text
            const progressText = document.getElementById('progressText');
            if (state.currentStage === 1) {
                progressText.textContent = `Signature ${state.samples.signatures.length + 1} of 3`; // Changed from 5 to 3
            } else if (state.currentStage === 2) {
                progressText.textContent = `Shape ${state.samples.shapes.length + 1} of 3`;
            } else {
                progressText.textContent = `Drawing ${state.samples.drawings.length + 1} of ${state.selectedChallenges.length}`;
            }
        }
        
        // Stage management
        function updateStageIndicator() {
            // Update stage icons
            for (let i = 1; i <= 3; i++) {
                const stage = document.getElementById(`stage${i}`);
                if (i < state.currentStage) {
                    stage.classList.add('completed');
                    stage.classList.remove('active');
                } else if (i === state.currentStage) {
                    stage.classList.add('active');
                    stage.classList.remove('completed');
                } else {
                    stage.classList.remove('active', 'completed');
                }
            }
        }
        
        // Update instructions
        function updateInstructions() {
            const instructions = document.getElementById('instructions');
            const drawingPrompt = document.getElementById('drawingPrompt');
            
            if (state.currentStage === 1) {
                if (state.samples.signatures.length === 0) {
                    instructions.innerHTML = "Let's start with your signature. Sign as you normally would - take your time.";
                } else {
                    instructions.innerHTML = `Good! Now sign again (${state.samples.signatures.length + 1} of 3). Try to keep it consistent.`; // Changed from 5 to 3
                }
                drawingPrompt.style.display = 'none';
            } else if (state.currentStage === 2) {
                instructions.innerHTML = "Now let's capture some basic shapes for added security.";
                const shapeIndex = state.samples.shapes.length;
                const shape = drawingChallenges.shapes[shapeIndex];
                drawingPrompt.textContent = shape.prompt;
                drawingPrompt.style.display = 'block';
            } else if (state.currentStage === 3) {
                instructions.innerHTML = "Finally, let's add some creative drawings that only you would draw this way.";
                const drawingIndex = state.samples.drawings.length;
                
                // Make sure challenges are selected
                if (!state.selectedChallenges || state.selectedChallenges.length === 0) {
                    selectRandomChallenges();
                }
                
                const challenge = state.selectedChallenges[drawingIndex];
                if (challenge && challenge.prompt) {
                    drawingPrompt.textContent = challenge.prompt;
                    
                    // Special handling for dots challenge
                    if (challenge.validation === 'dots' || challenge.prompt.includes('dots')) {
                        setTimeout(() => drawDots(), 100); // Small delay to ensure canvas is ready
                    }
                } else {
                    // Fallback
                    drawingPrompt.textContent = 'Draw something creative';
                }
                drawingPrompt.style.display = 'block';
            }
        }
        
        // Sample box management
        function updateSampleBoxes() {
            const container = document.getElementById('samplesContainer');
            
            if (state.currentStage === 1) {
                container.style.display = 'flex';
                // Update only first 3 boxes (hide boxes 4 and 5)
                for (let i = 0; i < 5; i++) {
                    const box = document.getElementById(`sample${i + 1}`);
                    if (i < 3) {  // Only show first 3 boxes
                        box.style.display = 'block';
                        if (i < state.samples.signatures.length) {
                            box.classList.add('completed');
                        } else {
                            box.classList.remove('completed');
                        }
                    } else {
                        box.style.display = 'none';  // Hide boxes 4 and 5
                    }
                }
            } else {
                container.style.display = 'none';
            }
        }
        
        // Handle canvas resize
        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext("2d").scale(ratio, ratio);
            signaturePad.clear();
        }
        
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        
        // Clear button
        document.getElementById('clear').addEventListener('click', () => {
            signaturePad.clear();
            drawingMetrics = {
                startTime: null,
                strokeCount: 0,
                totalDistance: 0,
                averageSpeed: 0,
                points: []
            };
            
            // Redraw dots if we're on the dots challenge
            if (state.currentStage === 3) {
                const drawingIndex = state.samples.drawings.length;
                const challenge = state.selectedChallenges[drawingIndex];
                if (challenge && (challenge.validation === 'dots' || challenge.prompt.includes('dots'))) {
                    setTimeout(() => drawDots(), 50);
                }
            }
            
            // Haptic feedback
            if ('vibrate' in navigator) {
                navigator.vibrate(20);
            }
        });
        
        // Show message
        function showMessage(text, isError = false) {
            const messageDiv = document.getElementById('message');
            messageDiv.className = isError ? 'message error' : 'message success';
            messageDiv.textContent = text;
            setTimeout(() => {
                messageDiv.textContent = '';
            }, 5000);
        }
        
        // Select random challenges for stage 3
        function selectRandomChallenges() {
            const shuffled = [...drawingChallenges.creative].sort(() => 0.5 - Math.random());
            state.selectedChallenges = shuffled.slice(0, 5); // Select 5 random challenges
        }
        
        // Function to draw dots on the canvas
        function drawDots() {
            const canvas = document.getElementById('signature-pad');
            const ctx = canvas.getContext('2d');
            
            // Save the current signature data
            const currentData = signaturePad.toData();
            
            // Clear and redraw
            signaturePad.clear();
            
            // Define 4 dot positions (spread across canvas)
            const dots = [
                { x: canvas.width * 0.25, y: canvas.height * 0.25 },
                { x: canvas.width * 0.75, y: canvas.height * 0.25 },
                { x: canvas.width * 0.25, y: canvas.height * 0.75 },
                { x: canvas.width * 0.75, y: canvas.height * 0.75 }
            ];
            
            // Draw the dots
            ctx.fillStyle = '#667eea';
            dots.forEach(dot => {
                ctx.beginPath();
                ctx.arc(dot.x, dot.y, 8, 0, 2 * Math.PI);
                ctx.fill();
                
                // Add numbers to dots
                ctx.fillStyle = 'white';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(dots.indexOf(dot) + 1, dot.x, dot.y);
                ctx.fillStyle = '#667eea';
            });
            
            // Restore previous strokes if any
            if (currentData.length > 0) {
                signaturePad.fromData(currentData);
            }
        }
        
        // Next button handler
        document.getElementById('next').addEventListener('click', async () => {
            if (state.mode === 'enrollment' && state.currentStage === 1 && state.samples.signatures.length === 0) {
                // First step - need username
                const username = document.getElementById('username').value.trim();
                if (!username) {
                    showMessage('Please enter a username', true);
                    return;
                }
                state.username = username;
                document.getElementById('username').style.display = 'none';
            }
            
            if (signaturePad.isEmpty()) {
                showMessage('Please complete the drawing before continuing', true);
                return;
            }
            
            // Capture current drawing
            const drawingData = signaturePad.toDataURL();
            const metrics = calculateMetrics();
            const signatureData = signaturePad.toData();
            
            const sampleData = {
                data: drawingData,
                metrics: metrics,
                raw: signatureData,
                timestamp: Date.now()
            };
            
            // Process based on current stage
            if (state.currentStage === 1) {
                // Signature stage
                state.samples.signatures.push(sampleData);
                
                // Check consistency
                if (state.samples.signatures.length > 1) {
                    const consistency = checkSignatureConsistency(
                        sampleData,
                        state.samples.signatures.slice(0, -1)
                    );
                    updateConsistencyIndicator(consistency);
                    
                    // If consistency is too low, suggest retry
                    if (consistency < 0.5 && state.samples.signatures.length < 5) {
                        showMessage('Signature very different - you may want to clear and try again', true);
                    }
                }
                
                // Check if we have enough signatures
                if (state.samples.signatures.length >= 3) {  // Changed from 5 to 3
                    // Move to shapes stage
                    state.currentStage = 2;
                    updateStageIndicator();
                }
            } else if (state.currentStage === 2) {
                // Shapes stage
                const shapeIndex = state.samples.shapes.length;
                const shape = drawingChallenges.shapes[shapeIndex];
                
                state.samples.shapes.push({
                    ...sampleData,
                    type: shape.validation
                });
                
                // Check if we have all shapes
                if (state.samples.shapes.length >= 3) {
                    // Move to creative drawings
                    state.currentStage = 3;
                    selectRandomChallenges();
                    updateStageIndicator();
                }
            } else if (state.currentStage === 3) {
                // Creative drawings stage
                const drawingIndex = state.samples.drawings.length;
                const challenge = state.selectedChallenges[drawingIndex];
                
                state.samples.drawings.push({
                    ...sampleData,
                    type: challenge.validation,
                    prompt: challenge.prompt
                });
                
                // Check if we're done
                if (state.samples.drawings.length >= state.selectedChallenges.length) {
                    // Complete enrollment
                    await completeEnrollment();
                    return;
                }
            }
            
            // Clear pad for next sample
            signaturePad.clear();
            drawingMetrics = {
                startTime: null,
                strokeCount: 0,
                totalDistance: 0,
                averageSpeed: 0,
                points: []
            };
            
            // Update UI
            updateProgress();
            updateInstructions();
            updateSampleBoxes();
        });
        
        // Complete enrollment
        async function completeEnrollment() {
            // Ensure challenges are selected
            if (!state.selectedChallenges || state.selectedChallenges.length === 0) {
                selectRandomChallenges();
            }
            
            const nextButton = document.getElementById('next');
            nextButton.disabled = true;
            nextButton.innerHTML = '<div class="spinner" style="width: 20px; height: 20px; margin: 0 auto;"></div>';
            
            try {
                // Since we only have 3, use all of them
                const bestSignatures = state.samples.signatures; // Use all 3 signatures
                
                // Prepare enrollment data
                const enrollmentData = {
                    username: state.username,
                    signatures: bestSignatures,
                    shapes: state.samples.shapes.reduce((acc, shape) => {
                        acc[shape.type] = shape;
                        return acc;
                    }, {}),
                    drawings: state.samples.drawings.reduce((acc, drawing) => {
                        acc[drawing.type] = drawing;
                        return acc;
                    }, {}),
                    metadata: {
                        enrollmentTime: Date.now(),
                        deviceInfo: {
                            userAgent: navigator.userAgent,
                            platform: navigator.platform,
                            touchSupport: 'ontouchstart' in window
                        }
                    }
                };
                
                // Send to backend
                const response = await fetch(`${API_URL}/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(enrollmentData)
                });
                
                if (response.ok) {
                    // Also send to ML backend for training
                    try {
                        for (const sig of bestSignatures) {
                            await fetch(`${ML_API_URL}/api/collect-signature`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    userId: state.username,
                                    type: 'genuine',
                                    signaturePadData: sig.raw,
                                    metrics: sig.metrics
                                })
                            });
                        }
                    } catch (mlError) {
                        console.error('ML training error:', mlError);
                    }
                    
                    showMessage('🎉 Enrollment complete! Your secure authentication is ready.');
                    
                    // Show completion UI
                    document.getElementById('mainContainer').innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <div style="font-size: 72px; margin-bottom: 20px;">✅</div>
                            <h2>You're All Set!</h2>
                            <p style="color: #666; margin: 20px 0;">Your unique signature and drawings have been securely saved.</p>
                            <button class="primary" onclick="location.reload()">Sign In</button>
                        </div>
                    `;
                } else {
                    const error = await response.json();
                    showMessage(error.message || 'Enrollment failed', true);
                    nextButton.disabled = false;
                    nextButton.textContent = 'Retry';
                }
            } catch (error) {
                console.error('Enrollment error:', error);
                showMessage('Connection error. Please try again.', true);
                nextButton.disabled = false;
                nextButton.textContent = 'Retry';
            }
        }
        
        // Skip to sign in
        document.getElementById('skipLink').addEventListener('click', (e) => {
            e.preventDefault();
            // Switch to authentication mode
            switchToAuthMode();
        });
        
        // Switch to authentication mode
        function switchToAuthMode() {
            state.mode = 'authentication';
            state.currentStage = 1;
            state.samples = { signatures: [], shapes: [], drawings: [] };
            
            document.getElementById('title').textContent = 'Welcome Back';
            document.getElementById('subtitle').textContent = 'Sign in with your signature';
            document.getElementById('username').style.display = 'block';
            document.getElementById('username').placeholder = 'Enter your username';
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('stageIndicator').style.display = 'none';
            document.getElementById('samplesContainer').style.display = 'none';
            document.getElementById('instructions').innerHTML = 'Enter your username and signature to sign in';
            document.getElementById('next').textContent = 'Sign In';
            document.getElementById('skipLink').textContent = 'Need an account? Sign up';
            document.getElementById('skipLink').onclick = () => location.reload();
            
            // Clear canvas
            signaturePad.clear();
        }
        
        // Authentication flow
        async function authenticate() {
            const username = document.getElementById('username').value.trim();
            if (!username) {
                showMessage('Please enter your username', true);
                return;
            }
            
            if (signaturePad.isEmpty()) {
                showMessage('Please sign your signature', true);
                return;
            }
            
            const nextButton = document.getElementById('next');
            nextButton.disabled = true;
            nextButton.innerHTML = '<div class="spinner" style="width: 20px; height: 20px; margin: 0 auto;"></div>';
            
            try {
                // Prepare authentication data
                const signatureData = {
                    data: signaturePad.toDataURL(),
                    metrics: calculateMetrics(),
                    raw: signaturePad.toData()
                };
                
                // First, get required challenges from backend
                const challengeResponse = await fetch(`${API_URL}/auth/challenges/${username}`);
                if (!challengeResponse.ok) {
                    showMessage('User not found', true);
                    nextButton.disabled = false;
                    nextButton.textContent = 'Sign In';
                    return;
                }
                
                const challenges = await challengeResponse.json();
                
                // TODO: Implement adaptive authentication based on confidence
                // For now, just verify signature
                const authData = {
                    username: username,
                    signature: signatureData,
                    deviceInfo: {
                        userAgent: navigator.userAgent,
                        platform: navigator.platform
                    }
                };
                
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(authData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Also verify with ML
                    try {
                        const mlResponse = await fetch(`${ML_API_URL}/api/verify-ml`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                userId: username,
                                signatureData: { strokes: signatureData.raw }
                            })
                        });
                        
                        const mlResult = await mlResponse.json();
                        
                        if (mlResult.success && mlResult.is_genuine) {
                            showMessage(`✅ Welcome back, ${username}! ML Confidence: ${mlResult.confidence.toFixed(0)}%`);
                        } else if (mlResult.success && !mlResult.is_genuine) {
                            showMessage('⚠️ Signature verification failed - additional verification required', true);
                            // TODO: Trigger additional challenges
                        }
                    } catch (mlError) {
                        console.error('ML verification error:', mlError);
                        showMessage(`Welcome back, ${username}!`);
                    }
                    
                    // Show success UI
                    setTimeout(() => {
                        document.getElementById('mainContainer').innerHTML = `
                            <div style="text-align: center; padding: 40px;">
                                <div style="font-size: 72px; margin-bottom: 20px;">👋</div>
                                <h2>Welcome back, ${username}!</h2>
                                <p style="color: #666; margin: 20px 0;">You've been successfully authenticated.</p>
                                <button class="primary" onclick="location.reload()">Sign Out</button>
                            </div>
                        `;
                    }, 2000);
                } else {
                    const error = await response.json();
                    showMessage(error.message || 'Authentication failed', true);
                    nextButton.disabled = false;
                    nextButton.textContent = 'Sign In';
                }
            } catch (error) {
                console.error('Authentication error:', error);
                showMessage('Connection error. Please try again.', true);
                nextButton.disabled = false;
                nextButton.textContent = 'Sign In';
            }
        }
        
        // Override next button for auth mode
        document.getElementById('next').addEventListener('click', async (e) => {
            if (state.mode === 'authentication') {
                e.stopImmediatePropagation();
                await authenticate();
            }
        });
        
        // Initialize
        updateProgress();
        updateInstructions();
        updateStageIndicator();
        
        // Show username input for enrollment
        if (state.mode === 'enrollment') {
            document.getElementById('username').style.display = 'block';
        }
    </script>
</body>
</html>